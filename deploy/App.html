<!DOCTYPE html>
<html>
<head>
    <title>defect-trend</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",dayRange:30,severityValues:[],priorityValues:[],stateValues:[],launch:function(){this.dumbChart=Ext.create("Rally.ui.chart.Chart",{itemId:"dumbChart",chartConfig:{chart:{type:"area"}},chartData:{series:[{name:"USA",data:[6]}]}}),this.add(this.dumbChart),this.down("#dumbChart").destroy(),Rally.data.ModelFactory.getModel({type:"Defect",success:function(model){this._severityDaisyChain(model)},scope:this})},_severityDaisyChain:function(model){var severity=model.getField("Severity"),store=severity.getAllowedValueStore();store.load({callback:function(data){_.each(data,function(el){""!=el.data.StringValue&&this.severityValues.push(el.data.StringValue)},this),console.log("severities",this.severityValues),this._priorityDaisyChain(model)},scope:this},this)},_priorityDaisyChain:function(model){var priority=model.getField("Priority"),store=priority.getAllowedValueStore();store.load({callback:function(data){_.each(data,function(el){""!=el.data.StringValue&&this.priorityValues.push(el.data.StringValue)},this),console.log("priorities",this.priorityValues),this._stateDaisyChain(model)},scope:this},this)},_stateDaisyChain:function(model){var state=model.getField("State"),store=state.getAllowedValueStore();store.load({callback:function(data){_.each(data,function(el){""!=el.data.StringValue&&this.stateValues.push(el.data.StringValue)},this),console.log("state values",this.stateValues),this._instantiatePicker()},scope:this},this)},_instantiatePicker:function(){this.add({xtype:"dayrangepicker",itemId:"dayRangePicker",defaultSelection:"30",autoLoadSelection:!0}),this.down("#dayRangePicker").on({on30clicked:function(){console.log(30),this.dayRange=DayRangePicker.THIRTY,this._getChartData()},on60clicked:function(){console.log(60),this.dayRange=DayRangePicker.SIXTY,this._getChartData()},on90clicked:function(){console.log(90),this.dayRange=DayRangePicker.NINETY,this._getChartData()},scope:this}),this._multiSelect(),this._getChartData()},_multiSelect:function(){var storeData=[];_.each(this.severityValues,function(value){storeData.push({_ref:value,ObjectId:value,Name:value})}),this.add({xtype:"rallymultiobjectpicker",modelType:"defect",storeConfig:{data:storeData}})},_getFilters:function(){var daysAgo=Ext.Date.add(new Date,Ext.Date.DAY,-this.dayRange),startOnISOString=Rally.util.DateTime.toIsoString(daysAgo,!0),filters=[{property:"_TypeHierarchy",operator:"in",value:["Defect"]},{property:"Severity",operator:"in",value:this.severityValues},{property:"Project",operator:"in",value:[279050021]},{property:"_ValidTo",operator:">=",value:startOnISOString}];return filters},_getChartData:function(){console.log("in get chart data");var myFilters=this._getFilters();this.down("#myChart")&&this.down("#myChart").destroy(),Ext.create("Rally.data.lookback.SnapshotStore",{listeners:{load:function(store,data,success){this._onDefectsLoaded(data)},scope:this},fetch:["Name","Severity"],autoLoad:!0,context:{workspace:"/workspace/41529001",project:"/project/279050021",projectScopeUp:!1,projectScopeDown:!0},hydrate:["Severity"],filters:myFilters,scope:this})},_getChartConfiguration:function(){return{chart:{type:"area"},title:{text:"Historic and Estimated Worldwide Population Growth by Region"},subtitle:{text:"Source: Wikipedia.org"},xAxis:{type:"datetime"},yAxis:{title:{text:"Count"},labels:{formatter:function(){return this.value}}},tooltip:{shared:!0},plotOptions:{area:{stacking:"normal",lineColor:"#666666",lineWidth:1,marker:{lineWidth:1,lineColor:"#666666"}}}}},_onDefectsLoaded:function(data){var snapShotData=_.map(data,function(d){return d.data}),holidays=[{year:2014,month:1,day:1}],metrics=[];_.each(this.severityValues,function(value){metrics.push({as:value,f:"filteredCount",filterField:"Severity",filterValues:[value]})}),console.log(metrics);var summaryMetricsConfig=[],derivedFieldsAfterSummary=[],deriveFieldsOnInput=[],config={metrics:metrics,granularity:"day",tz:"America/Chicago",holidays:holidays,workDays:"Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday",summaryMetricsConfig:summaryMetricsConfig,deriveFieldsAfterSummary:derivedFieldsAfterSummary,deriveFieldsOnInput:deriveFieldsOnInput},daysAgo=Ext.Date.add(new Date,Ext.Date.DAY,-this.dayRange),currentDate=Ext.Date.add(new Date,Ext.Date.DAY,0),startOnISOString=Rally.util.DateTime.toIsoString(daysAgo,!0),upToDateISOString=Rally.util.DateTime.toIsoString(currentDate,!0);calculator=new Rally.data.lookback.Lumenize.TimeSeriesCalculator(config),calculator.addSnapshots(snapShotData,startOnISOString,upToDateISOString);var hcConfig=[];_.each(this.severityValues,function(value){hcConfig.push({name:value})});var hcData=Rally.data.lookback.Lumenize.arrayOfMaps_To_HighChartsSeries(calculator.getResults().seriesData,hcConfig),dt;_.each(hcData,function(seriesObj){dt=Ext.Date.format(daysAgo,"Y-m-d").split("-"),seriesObj.pointStart=Date.UTC(dt[0],dt[1]-1,dt[2]),seriesObj.pointInterval=864e5});var myChart=Ext.create("Rally.ui.chart.Chart",{chartConfig:this._getChartConfiguration(),chartData:{series:hcData},itemId:"myChart"});this.add(myChart),Ext.util.Observable.capture(myChart,function(e){return console.log("chart %s - %s",myChart.getId(),e),!0})}});
                Ext.define("DayRangePicker",{extend:"Ext.Component",alias:"widget.dayrangepicker",statics:{THIRTY:"30",SIXTY:"60",NINETY:"90"},config:{defaultSelection:"90",autoLoadSelection:!1},constructor:function(config){this.initConfig(config),this._validateSettings(),this.callParent(arguments),this.addEvents("on30clicked","on60clicked","on90clicked"),Rally.environment.getMessageBus().subscribe("DayRangePicker.rangeChanged",this._onRangeChanged,this)},renderTpl:'<span id="{id}-s30">30 days</span>  |  <span id="{id}-s60">60 days</span>  |  <span id="{id}-s90">90 days</span>',childEls:["s30","s60","s90"],style:{textAlign:"center",paddingTop:"5px",paddingBottom:"5px;"},listeners:{on30clicked:function(){this.s30.hasCls("selected")||(this.s30.removeCls("selected").removeCls("notselected").addCls("selected"),this.s60.removeCls("selected").removeCls("notselected").addCls("notselected"),this.s90.removeCls("selected").removeCls("notselected").addCls("notselected"),Rally.environment.getMessageBus().publish("DayRangePicker.rangeChanged",DayRangePicker.THIRTY,this))},on60clicked:function(){this.s60.hasCls("selected")||(this.s60.removeCls("selected").removeCls("notselected").addCls("selected"),this.s30.removeCls("selected").removeCls("notselected").addCls("notselected"),this.s90.removeCls("selected").removeCls("notselected").addCls("notselected"),Rally.environment.getMessageBus().publish("DayRangePicker.rangeChanged",DayRangePicker.SIXTY,this))},on90clicked:function(){this.s90.hasCls("selected")||(this.s90.removeCls("selected").removeCls("notselected").addCls("selected"),this.s60.removeCls("selected").removeCls("notselected").addCls("notselected"),this.s30.removeCls("selected").removeCls("notselected").addCls("notselected"),Rally.environment.getMessageBus().publish("DayRangePicker.rangeChanged",DayRangePicker.NINETY,this))}},afterRender:function(){this.s30.addCls("notselected"),this.s60.addCls("notselected"),this.s90.addCls("notselected"),this.s30.on("click",function(){this.fireEvent("on30clicked")},this),this.s60.on("click",function(){this.fireEvent("on60clicked")},this),this.s90.on("click",function(){this.fireEvent("on90clicked")},this),this.getAutoLoadSelection()&&(this["s"+this.getDefaultSelection()].removeCls("notselected").addCls("selected"),this.fireEvent("on"+this.getDefaultSelection()+"clicked"))},_onRangeChanged:function(dayRange,source){if(source!==this)switch(dayRange){case DayRangePicker.THIRTY:this.fireEvent("on30clicked");break;case DayRangePicker.SIXTY:this.fireEvent("on60clicked");break;case DayRangePicker.NINETY:this.fireEvent("on90clicked")}},_validateSettings:function(config){this.getDefaultSelection()!==DayRangePicker.THIRTY&&this.getDefaultSelection()!==DayRangePicker.SIXTY&&this.getDefaultSelection()!==DayRangePicker.NINETY&&(console.error("Invalid 'defaultSelection' setting ["+this.getDefaultSelection()+"].  Must be 30, 60, or 90.  Defaulting to "+DayRangePicker.THIRTY+"."),this.setDefaultSelection(DayRangePicker.SIXTY))}});

            Rally.launchApp('CustomApp', {
                name:"defect-trend",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
        
}
        
.reworkCountNumber {
    font-family: 'Carter One', cursive;
    font-family: 'Leckerli One', cursive;
    font-size: 10em;
    text-align: center
}

.reworkCountText {
    font-size: 2em;
    text-align: center
}

.selected {
  font-size: 1.4em;
  font-weight: bold;
  color: #000;
}

.notselected {
  font-size: 1.3em;
  color: #333;
}

span.notselected:hover {
  text-decoration: underline;
}

    </style>
</head>
<body></body>
</html>
