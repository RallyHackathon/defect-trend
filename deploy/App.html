<!DOCTYPE html>
<html>
<head>
    <title>defect-trend</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc1/lib/analytics/analytics-all.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this._getChartData()},_getChartData:function(){console.log("context",this.getContext(),this.getContext().getWorkspace(),this.getContext().getProject()),Ext.create("Rally.data.lookback.SnapshotStore",{listeners:{load:this._onDefectsLoaded,scope:this},fetch:["Name","Severity"],autoLoad:!0,context:{workspace:this.getContext().getWorkspaceRef(),project:this.getContext().getProjectRef(),projectScopeUp:!1,projectScopeDown:!0},hydrate:["Severity"],filters:[{property:"_TypeHierarchy",operator:"in",value:["Defect"]},{property:"Severity",operator:"in",value:["Minor Problem","Major Problem","Cosmetic"]},{property:"Project",operator:"in",value:[this.getContext().getProject().ObjectID]}],scope:this}),console.log("project",this.getContext().getProject())},_getChartConfiguration:function(){return{chart:{type:"area"},title:{text:"Defect Trend"},subtitle:{text:"by Severity"},xAxis:{type:"datetime"},yAxis:{title:{text:"Count"},labels:{formatter:function(){return this.value}}},tooltip:{shared:!0},plotOptions:{area:{stacking:"normal",lineColor:"#666666",lineWidth:1,marker:{lineWidth:1,lineColor:"#666666"}}}}},_onDefectsLoaded:function(store,data,success){var lumenize=window.parent.Rally.data.lookback.Lumenize,snapShotData=_.map(data,function(d){return d.data});console.log("snapshots:",data);var holidays=[{year:2014,month:1,day:1}],metrics=[{as:"defectMajor",f:"filteredCount",filterField:"Severity",filterValues:["Major Problem"]},{as:"defectMinor",f:"filteredCount",filterField:"Severity",filterValues:["Minor Problem"]},{as:"defectCosmetic",f:"filteredCount",filterField:"Severity",filterValues:["Cosmetic"]}],summaryMetricsConfig=[],derivedFieldsAfterSummary=[],deriveFieldsOnInput=[],config={metrics:metrics,granularity:lumenize.Time.DAY,tz:"America/Chicago",holidays:holidays,workDays:"Monday,Tuesday,Wednesday,Thursday,Friday",summaryMetricsConfig:summaryMetricsConfig,deriveFieldsAfterSummary:derivedFieldsAfterSummary,deriveFieldsOnInput:deriveFieldsOnInput},startOnISOString=new lumenize.Time("2013-09-15").getISOStringInTZ(config.tz),upToDateISOString=new lumenize.Time("2013-10-15").getISOStringInTZ(config.tz);calculator=new lumenize.TimeSeriesCalculator(config),calculator.addSnapshots(snapShotData,startOnISOString,upToDateISOString);var hcConfig=[{name:"defectMajor"},{name:"defectMinor"},{name:"defectCosmetic"}],hcData=lumenize.arrayOfMaps_To_HighChartsSeries(calculator.getResults().seriesData,hcConfig);_.each(hcData,function(seriesObj){seriesObj.pointStart=Date.UTC(2013,8,15),seriesObj.pointInterval=864e5}),console.log("chart data: ",hcData);var myChart=Ext.create("Rally.ui.chart.Chart",{chartConfig:this._getChartConfiguration(),chartData:{series:hcData}});this.add(myChart)}});

            Rally.launchApp('CustomApp', {
                name:"defect-trend",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
