<!DOCTYPE html>
<html>
<head>
    <title>defect-trend</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc1/lib/analytics/analytics-all.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"dayrangepicker",itemId:"dayRangePicker",defaultSelection:"30",autoLoadSelection:!0}],dayRange:90,launch:function(){this.down("#dayRangePicker").on({on30clicked:function(){console.log(30),this.dayRange=DayRangePicker.THIRTY,this._getChartData()},on60clicked:function(){console.log(60),this.dayRange=DayRangePicker.SIXTY,this._getChartData()},on90clicked:function(){console.log(90),this.dayRange=DayRangePicker.NINETY,this._getChartData()},scope:this})},_getChartData:function(){this.down("#myChart")&&this.down("#myChart").destroy(),this.myData?this._onDefectsLoaded(this.myData):Ext.create("Rally.data.lookback.SnapshotStore",{listeners:{load:function(store,data,success){this.myData=data,this._onDefectsLoaded(this.myData)},scope:this},fetch:["Name","Severity"],autoLoad:!0,context:{workspace:"/workspace/41529001",project:"/project/279050021",projectScopeUp:!1,projectScopeDown:!0},hydrate:["Severity"],filters:[{property:"_TypeHierarchy",operator:"in",value:["Defect"]},{property:"Severity",operator:"in",value:["Minor Problem","Major Problem","Cosmetic"]},{property:"Project",operator:"in",value:[279050021]}],scope:this})},_getChartConfiguration:function(){return{chart:{type:"area"},title:{text:"Historic and Estimated Worldwide Population Growth by Region"},subtitle:{text:"Source: Wikipedia.org"},xAxis:{type:"datetime"},yAxis:{title:{text:"Count"},labels:{formatter:function(){return this.value}}},tooltip:{shared:!0},plotOptions:{area:{stacking:"normal",lineColor:"#666666",lineWidth:1,marker:{lineWidth:1,lineColor:"#666666"}}}}},_onDefectsLoaded:function(data){var lumenize=window.parent.Rally.data.lookback.Lumenize,snapShotData=_.map(data,function(d){return d.data}),holidays=[{year:2014,month:1,day:1}],metrics=[{as:"defectMajor",f:"filteredCount",filterField:"Severity",filterValues:["Major Problem"]},{as:"defectMinor",f:"filteredCount",filterField:"Severity",filterValues:["Minor Problem"]},{as:"defectCosmetic",f:"filteredCount",filterField:"Severity",filterValues:["Cosmetic"]}],summaryMetricsConfig=[],derivedFieldsAfterSummary=[],deriveFieldsOnInput=[],config={metrics:metrics,granularity:lumenize.Time.DAY,tz:"America/Chicago",holidays:holidays,workDays:"Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday",summaryMetricsConfig:summaryMetricsConfig,deriveFieldsAfterSummary:derivedFieldsAfterSummary,deriveFieldsOnInput:deriveFieldsOnInput},daysAgo=Ext.Date.add(new Date,Ext.Date.DAY,-this.dayRange);console.log(daysAgo);var currentDate=Ext.Date.add(new Date,Ext.Date.DAY,0),startOnISOString=Rally.util.DateTime.toIsoString(daysAgo,!0),upToDateISOString=Rally.util.DateTime.toIsoString(currentDate,!0);console.log("start date",startOnISOString),console.log("end date",upToDateISOString),console.log("days ago",daysAgo),calculator=new lumenize.TimeSeriesCalculator(config),calculator.addSnapshots(snapShotData,startOnISOString,upToDateISOString);var hcConfig=[{name:"defectMajor"},{name:"defectMinor"},{name:"defectCosmetic"}],hcData=lumenize.arrayOfMaps_To_HighChartsSeries(calculator.getResults().seriesData,hcConfig),dt;console.log(hcData),_.each(hcData,function(seriesObj){dt=Ext.Date.format(daysAgo,"Y-m-d").split("-"),seriesObj.pointStart=Date.UTC(dt[0],dt[1]-1,dt[2]),seriesObj.pointInterval=864e5});var myChart=Ext.create("Rally.ui.chart.Chart",{chartConfig:this._getChartConfiguration(),chartData:{series:hcData},itemId:"myChart"});this.add(myChart),Ext.util.Observable.capture(myChart,function(e){return console.log("chart %s - %s",myChart.getId(),e),!0})}});
                Ext.define("DayRangePicker",{extend:"Ext.Component",alias:"widget.dayrangepicker",statics:{THIRTY:"30",SIXTY:"60",NINETY:"90"},config:{defaultSelection:"90",autoLoadSelection:!1},constructor:function(config){this.initConfig(config),this._validateSettings(),this.callParent(arguments),this.addEvents("on30clicked","on60clicked","on90clicked"),Rally.environment.getMessageBus().subscribe("DayRangePicker.rangeChanged",this._onRangeChanged,this)},renderTpl:'<span id="{id}-s30">30 days</span>  |  <span id="{id}-s60">60 days</span>  |  <span id="{id}-s90">90 days</span>',childEls:["s30","s60","s90"],style:{textAlign:"center",paddingTop:"5px",paddingBottom:"5px;"},listeners:{on30clicked:function(){this.s30.hasCls("selected")||(this.s30.removeCls("selected").removeCls("notselected").addCls("selected"),this.s60.removeCls("selected").removeCls("notselected").addCls("notselected"),this.s90.removeCls("selected").removeCls("notselected").addCls("notselected"),Rally.environment.getMessageBus().publish("DayRangePicker.rangeChanged",DayRangePicker.THIRTY,this))},on60clicked:function(){this.s60.hasCls("selected")||(this.s60.removeCls("selected").removeCls("notselected").addCls("selected"),this.s30.removeCls("selected").removeCls("notselected").addCls("notselected"),this.s90.removeCls("selected").removeCls("notselected").addCls("notselected"),Rally.environment.getMessageBus().publish("DayRangePicker.rangeChanged",DayRangePicker.SIXTY,this))},on90clicked:function(){this.s90.hasCls("selected")||(this.s90.removeCls("selected").removeCls("notselected").addCls("selected"),this.s60.removeCls("selected").removeCls("notselected").addCls("notselected"),this.s30.removeCls("selected").removeCls("notselected").addCls("notselected"),Rally.environment.getMessageBus().publish("DayRangePicker.rangeChanged",DayRangePicker.NINETY,this))}},afterRender:function(){this.s30.addCls("notselected"),this.s60.addCls("notselected"),this.s90.addCls("notselected"),this.s30.on("click",function(){this.fireEvent("on30clicked")},this),this.s60.on("click",function(){this.fireEvent("on60clicked")},this),this.s90.on("click",function(){this.fireEvent("on90clicked")},this),this.getAutoLoadSelection()&&(this["s"+this.getDefaultSelection()].removeCls("notselected").addCls("selected"),this.fireEvent("on"+this.getDefaultSelection()+"clicked"))},_onRangeChanged:function(dayRange,source){if(source!==this)switch(dayRange){case DayRangePicker.THIRTY:this.fireEvent("on30clicked");break;case DayRangePicker.SIXTY:this.fireEvent("on60clicked");break;case DayRangePicker.NINETY:this.fireEvent("on90clicked")}},_validateSettings:function(config){this.getDefaultSelection()!==DayRangePicker.THIRTY&&this.getDefaultSelection()!==DayRangePicker.SIXTY&&this.getDefaultSelection()!==DayRangePicker.NINETY&&(console.error("Invalid 'defaultSelection' setting ["+this.getDefaultSelection()+"].  Must be 30, 60, or 90.  Defaulting to "+DayRangePicker.THIRTY+"."),this.setDefaultSelection(DayRangePicker.SIXTY))}});

            Rally.launchApp('CustomApp', {
                name:"defect-trend",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
        
}
        
.reworkCountNumber {
    font-family: 'Carter One', cursive;
    font-family: 'Leckerli One', cursive;
    font-size: 10em;
    text-align: center
}

.reworkCountText {
    font-size: 2em;
    text-align: center
}

.selected {
  font-size: 1.4em;
  font-weight: bold;
  color: #000;
}

.notselected {
  font-size: 1.3em;
  color: #333;
}

span.notselected:hover {
  text-decoration: underline;
}

    </style>
</head>
<body></body>
</html>
